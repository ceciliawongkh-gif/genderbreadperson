<script>
    const canvas = document.getElementById('genderCanvas');
    const ctx = canvas.getContext('2d');
    const img = new Image();
    img.src = './printable-genderbread-person-c-a5-1024x722-1.jpg';
    
    let gi = 50, ge = 50, sex = 50, so = 50;
    
    img.onload = () => {
        console.log('Image loaded, starting morphs');
        drawGenderbread();
    };
    img.onerror = () => {
        console.error('Image load failed');
        ctx.fillStyle = 'red';
        ctx.fillRect(0, 0, canvas.width, canvas.height);
    };
    
    function drawGenderbread() {
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
        
        const giNorm = gi / 100; // 0=woman, 1=man
        const geNorm = ge / 100; // 0=fem, 1=masc
        
        // Global composite for better blending
        ctx.globalCompositeOperation = 'multiply'; // Darkens overlays over image
        
        // 1. HAIR - Much larger, covers head fully
        ctx.globalAlpha = 0.8;
        ctx.fillStyle = `hsl(${240 + giNorm * 60}, 70%, ${30 + giNorm * 30}%)`;
        const hairScale = 1.5 + (1 - (giNorm + geNorm)/2) * 1.5; // 1.5-3x size
        ctx.save();
        ctx.translate(canvas.width/2, 80);
        ctx.scale(hairScale, hairScale);
        ctx.beginPath();
        ctx.arc(0, 0, 100, 0, Math.PI * 2);
        ctx.fill();
        ctx.restore();
        // Strands
        ctx.globalAlpha = 0.6;
        for (let i = 0; i < 15 + geNorm * 10; i++) {
            ctx.strokeStyle = ctx.fillStyle + '80';
            ctx.lineWidth = 5 - geNorm * 2;
            ctx.lineCap = 'round';
            ctx.beginPath();
            ctx.moveTo(canvas.width/2 + (Math.sin(i)*80), 50 + Math.random()*30);
            ctx.lineTo(canvas.width/2 + (Math.sin(i+1)*100), 150 + geNorm * 50);
            ctx.stroke();
        }
        
        // 2. FACE - Larger oval overlay
        ctx.globalAlpha = 0.7;
        ctx.globalCompositeOperation = 'source-over';
        ctx.fillStyle = giNorm > 0.5 ? '#deb887' : '#ffe4e1'; // Tan to peach
        ctx.save();
        ctx.translate(canvas.width/2, 200);
        ctx.scale(1.2, 1 + giNorm * 0.3);
        ctx.beginPath();
        ctx.ellipse(0, 0, 90, 110, 0, 0, Math.PI * 2);
        ctx.fill();
        ctx.restore();
        
        // 3. BODY - Full torso/lower coverage
        ctx.globalAlpha = 0.6;
        ctx.fillStyle = '#f5deb3';
        ctx.beginPath();
        const shoulderW = 180 + geNorm * 120;
        const waistW = 120 - (1-giNorm)*50 + geNorm*20;
        const hipW = 160 + (1-giNorm)*60 - geNorm*40;
        ctx.moveTo(canvas.width/2 - shoulderW/2, 280);
        ctx.lineTo(canvas.width/2 + shoulderW/2, 280);
        ctx.quadraticCurveTo(canvas.width/2 + shoulderW/2 * 0.8, 420, canvas.width/2 + waistW/2, 480);
        ctx.lineTo(canvas.width/2 - waistW/2, 480);
        ctx.quadraticCurveTo(canvas.width/2 - shoulderW/2 * 0.8, 420, canvas.width/2 - shoulderW/2, 280);
        ctx.lineTo(canvas.width/2 + hipW/2, 550); // Hips curve
        ctx.lineTo(canvas.width/2 - hipW/2, 550);
        ctx.closePath();
        ctx.fill();
        
        // Arms thicker
        const armT = 30 + geNorm * 25;
        ctx.fillRect(canvas.width/2 - shoulderW/2 - 10, 290, armT, 160);
        ctx.fillRect(canvas.width/2 + shoulderW/2 - armT + 10, 290, armT, 160);
        
        // 4. CLOTHING - Prominent
        ctx.globalAlpha = 0.9;
        ctx.globalCompositeOperation = 'screen'; // Brightens
        ctx.fillStyle = `hsl(${320 - giNorm * 140}, 80%, ${45 + (50 - geNorm * 25)}%)`;
        if ((1 - giNorm - geNorm) > 0.2) { // Dress
            ctx.beginPath();
            ctx.ellipse(canvas.width/2, 520, hipW/1.5, 200, 0, 0, Math.PI * 2);
            ctx.fill();
        } else { // Shirt/pants
            ctx.fillRect(canvas.width/2 - 80, 280, 160, 180);
            ctx.fillRect(canvas.width/2 - 40, 460, 80, 150);
        }
        
        // 5. Sex symbols - Larger
        ctx.globalAlpha = 0.5;
        ctx.globalCompositeOperation = 'source-over';
        ctx.font = 'bold 80px Arial';
        ctx.textAlign = 'center';
        ctx.textBaseline = 'middle';
        if (sex / 100 < 0.5) {
            ctx.fillText('♀', canvas.width * 0.2, canvas.height * 0.8);
        } else if (sex / 100 > 0.5) {
            ctx.fillText('♂', canvas.width * 0.8, canvas.height * 0.8);
        }
        
        // 6. HEART - Bigger glow
        ctx.globalAlpha = 1;
        const soNorm = so / 100;
        const heartX = canvas.width * 0.5;
        const heartY = 320;
        ctx.shadowColor = soNorm < 0.5 ? '#ff69b4' : '#4a90e2';
        ctx.shadowBlur = 50;
        ctx.shadowOffsetX = 0;
        ctx.shadowOffsetY = 0;
        ctx.fillStyle = soNorm < 0.5 ? '#ff1493' : '#1e90ff';
        ctx.beginPath();
        ctx.moveTo(heartX, heartY);
        ctx.bezierCurveTo(heartX, heartY-60, heartX-60, heartY-30, heartX-45, heartY+15);
        ctx.bezierCurveTo(heartX-75, heartY+75, heartX, heartY+90, heartX, heartY+60);
        ctx.bezierCurveTo(heartX, heartY+90, heartX+75, heartY+75, heartX+45, heartY+15);
        ctx.bezierCurveTo(heartX+60, heartY-30, heartX, heartY-60, heartX, heartY);
        ctx.closePath();
        ctx.fill();
        ctx.shadowBlur = 0;
        ctx.globalCompositeOperation = 'source-over';
        
        console.log(`Redrawn: GI=${gi}, GE=${ge}`); // Debug
    }
    
    // Slider handlers (unchanged, but call draw every time)
    const sliders = { genderIdentity: 'gi', genderExpression: 'ge', biologicalSex: 'sex', sexualOrientation: 'so' };
    Object.keys(sliders).forEach(id => {
        const slider = document.getElementById(id);
        const valueDisplay = document.getElementById(id === 'genderIdentity' ? 'giValue' : id === 'genderExpression' ? 'geValue' : id === 'biologicalSex' ? 'sexValue' : 'soValue');
        const labelLeft = document.getElementById(id.replace(/([A-Z])/g, 'LabelLeft').toLowerCase().replace('labelleft', 'giLabelLeft') || /* fallback */ document.querySelector(`#${id}LabelLeft`)); // Fixed selector bug potential
        const labelRight = document.getElementById(id.replace(/([A-Z])/g, 'LabelRight').toLowerCase().replace('labelright', 'giLabelRight') || document.querySelector(`#${id}LabelRight`));

        slider.addEventListener('input', (e) => {
            const value = parseInt(e.target.value);
            window[sliders[id]] = value;
            valueDisplay.textContent = `${value}%`;
            const leftPct = 100 - value;
            if (labelLeft) labelLeft.textContent = `${leftPct}% ${labelLeft.textContent.split('%')[1]?.trim() || labelLeft.textContent.split(' ')[1] || ''}`;
            if (labelRight) labelRight.textContent = `${value}% ${labelRight.textContent.split('%')[1]?.trim() || labelRight.textContent.split(' ')[1] || ''}`;
            drawGenderbread(); // Always redraw
        });
    });
    
    // Initial
    setTimeout(drawGenderbread, 100);
</script>
