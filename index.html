<!DOCTYPE html>
<!-- [Keep all the existing <head> and <style> unchanged] -->
<body>
    <!-- [Keep all HTML content unchanged until the <script>] -->
    
    <script>
        // Fixed state management - use object to avoid conflicts
        const spectrumState = {
            gi: 50, ge: 50, sex: 50, so: 50
        };

        function updateSliderLabels(sliderId, value) {
            const mappings = {
                'genderIdentity': { left: 'giLabelLeft', right: 'giLabelRight', value: 'giValue' },
                'genderExpression': { left: 'geLabelLeft', right: 'geLabelRight', value: 'geValue' },
                'biologicalSex': { left: 'sexLabelLeft', right: 'sexLabelRight', value: 'sexValue' },
                'sexualOrientation': { left: 'soLabelLeft', right: 'soLabelRight', value: 'soValue' }
            };
            const m = mappings[sliderId];
            if (m) {
                document.getElementById(m.left).textContent = `${100-value}% ${document.getElementById(m.left).textContent.split('%')[1]?.trim() || ''}`;
                document.getElementById(m.right).textContent = `${value}% ${document.getElementById(m.right).textContent.split('%')[1]?.trim() || ''}`;
                document.getElementById(m.value).textContent = `${value}%`;
            }
        }

        function updateSpectrumColor() {
            const { gi, ge, sex, so } = spectrumState;
            const r = Math.round((gi / 100) * 255);
            const g = Math.round((ge / 100) * 255);
            const b = Math.round((sex / 100) * 255);
            const modifier = (so / 100) * 0.4; // Slight boost for vibrancy
            
            const patch = document.getElementById('spectrum-color');
            const brightR = Math.min(255, r + Math.round(60 * modifier));
            const brightG = Math.min(255, g + Math.round(60 * modifier));
            const brightB = Math.min(255, b + Math.round(60 * modifier));
            const darkR = Math.max(0, r - 40);
            const darkG = Math.max(0, g - 40);
            const darkB = Math.max(0, b - 40);
            
            patch.style.background = `radial-gradient(circle at center, 
                rgb(${brightR}, ${brightG}, ${brightB}) 0%, 
                rgb(${r}, ${g}, ${b}) 50%, 
                rgb(${darkR}, ${darkG}, ${darkB}) 100%)`;
            
            // Debug log (remove in production)
            console.log(`Spectrum: GI:${gi}(${r}) GE:${ge}(${g}) Sex:${sex}(${b}) SO:${so} -> rgb(${r},${g},${b})`);
        }

        // Corrected event listeners with proper state updates
        document.getElementById('genderIdentity').addEventListener('input', (e) => {
            spectrumState.gi = parseInt(e.target.value);
            updateSliderLabels('genderIdentity', spectrumState.gi);
            updateSpectrumColor();
        });

        document.getElementById('genderExpression').addEventListener('input', (e) => {
            spectrumState.ge = parseInt(e.target.value);
            updateSliderLabels('genderExpression', spectrumState.ge);
            updateSpectrumColor();
        });

        document.getElementById('biologicalSex').addEventListener('input', (e) => {
            spectrumState.sex = parseInt(e.target.value);
            updateSliderLabels('biologicalSex', spectrumState.sex);
            updateSpectrumColor();
        });

        document.getElementById('sexualOrientation').addEventListener('input', (e) => {
            spectrumState.so = parseInt(e.target.value);
            updateSliderLabels('sexualOrientation', spectrumState.so);
            updateSpectrumColor();
        });

        function shareMySpectrum() {
            const { gi, ge, sex, so } = spectrumState;
            const r = Math.round((gi / 100) * 255);
            const g = Math.round((ge / 100) * 255);
            const b = Math.round((sex / 100) * 255);
            const shareText = `ðŸŒˆ My Spectrum Color: rgb(${r}, ${g}, ${b})\nGI:${gi}% | GE:${ge}% | Sex:${sex}% | SO:${so}%\n#SpectrumOfUs\nTheSpectrumOfUs.com`;
            
            if (navigator.clipboard) {
                navigator.clipboard.writeText(shareText).then(() => {
                    downloadSwatch(r, g, b);
                    alert('âœ… Color copied & swatch downloaded!');
                });
            } else {
                downloadSwatch(r, g, b);
                prompt('Copy this:', shareText);
            }
        }

        function downloadSwatch(r, g, b) {
            const canvas = document.createElement('canvas');
            canvas.width = 400; canvas.height = 250;
            const ctx = canvas.getContext('2d');
            ctx.fillStyle = `rgb(${r}, ${g}, ${b})`;
            ctx.fillRect(0, 0, 400, 250);
            ctx.fillStyle = 'white';
            ctx.font = 'bold 24px Poppins';
            ctx.textAlign = 'center';
            ctx.fillText(`rgb(${r}, ${g}, ${b})`, 200, 120);
            
            const link = document.createElement('a');
            link.href = canvas.toDataURL();
            link.download = `spectrum-swatch-${Date.now()}.png`;
            link.click();
        }

        // Initialize everything
        updateSpectrumColor();
        ['genderIdentity', 'genderExpression', 'biologicalSex', 'sexualOrientation'].forEach(id => {
            const slider = document.getElementById(id);
            updateSliderLabels(id, parseInt(slider.value));
        });
        
        // Image error handling
        document.getElementById('genderbread-img').onerror = () => {
            console.warn('Genderbread image not found - check repo root');
        };
    </script>
</body>
</html>
